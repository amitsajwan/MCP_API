<!DOCTYPE html>
        <html lang='en'>
        <head>
            <meta charset='UTF-8'/>
            <title>API Assistant (Simple)</title>
            <style>
                :root { color-scheme: dark; }
                body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:#111; color:#eee; display:flex; flex-direction:column; height:100vh; }
                header { padding:0.75rem 1rem; background:#181818; font-weight:600; letter-spacing:.5px; }
                #log { flex:1; overflow:auto; padding:1rem; line-height:1.4; }
                .msg { margin:0 0 .85rem; }
                .msg.user { color:#9ad6ff; }
                .msg.assistant { color:#c6f6c6; }
                .msg.system { color:#aaa; font-style:italic; }
                .bubble { padding:.6rem .75rem; background:#222; border-radius:8px; display:inline-block; max-width:70ch; white-space:pre-wrap; word-break:break-word; }
                .user .bubble { background:#123d55; }
                .assistant .bubble { background:#1d3d1d; }
                form { display:flex; gap:.5rem; padding:.75rem; background:#181818; }
                input[type=text] { flex:1; padding:.55rem .7rem; border:1px solid #333; border-radius:6px; background:#101010; color:#eee; }
                input[type=text]:focus { outline:2px solid #2c5aa0; }
                button { padding:.55rem 1rem; border:1px solid #2d5fff; background:#2d5fff; color:#fff; border-radius:6px; cursor:pointer; font-weight:600; }
                button:disabled { opacity:.55; cursor:progress; }
                .toolbar { display:flex; gap:1rem; align-items:center; padding:0 .75rem .5rem; font-size:.8rem; flex-wrap:wrap; }
                label { display:inline-flex; align-items:center; gap:.35rem; cursor:pointer; }
                .small { font-size:.7rem; opacity:.65; }
                #status { font-size:.7rem; opacity:.7; margin-left:auto; }
                a { color:#58a6ff; }
                .status-message {
                    padding: 8px 12px;
                    margin: 8px 0;
                    border-radius: 4px;
                    font-size: 12px;
                    animation: fadeIn 0.3s ease-in;
                }
                
                .status-message.success {
                    background-color: #1d3d1d;
                    color: #4ade80;
                    border: 1px solid #2d5a2d;
                }
                
                .status-message.error {
                    background-color: #3d1d1d;
                    color: #ff6b6b;
                    border: 1px solid #5a2d2d;
                }
                
                .status-message.info {
                    background-color: #1d2d3d;
                    color: #58a6ff;
                    border: 1px solid #2d3d5a;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            </style>
        </head>
        <body>
            <header>API Assistant (Simple)</header>
            <div class='toolbar'>
                <span class='small'>Type a prompt like: <code>pending payments status=pending</code> or <code>cash summary</code></span>
                <span id='loginStatus' style='color:#ff6b6b; font-weight:600;'>Not Configured</span>
                <span id='status'>Idle</span>
                <button id='cfgBtn' style='margin-left:auto; background:#ff6b6b; border-color:#ff6b6b;'>Login & Configure</button>
            </div>

            <div id='log'></div>
            <dialog id='cfgDlg'>
                <form method='dialog' id='cfgForm' style='display:flex;flex-direction:column;gap:.5rem;min-width:320px;'>
                    <h3>Configure Credentials</h3>
                    <label>Username <input type='text' id='cfgUser' required></label>
                    <label>Password <input type='password' id='cfgPass' required></label>
                    <label>Base URL <input type='text' id='cfgBase' placeholder='http://127.0.0.1:9001' required></label>
                    
                    <div style='display:flex;gap:.5rem;justify-content:flex-end'>
                        <button value='cancel'>Cancel</button>
                        <button id='cfgSave' value='default'>Save</button>
                    </div>
                    <p class='small'>Tip: DEV/TE1/TE2 can be mapped by Base URL (e.g., http://dev-host:port)</p>
                </form>
            </dialog>
            <form id='chatForm'>
                <input id='input' type='text' autocomplete='off' placeholder='Ask something (e.g., show pending payments status=pending)' />
                <button id='sendBtn' type='submit'>Send</button>

            </form>
            <script>
                const logEl = document.getElementById('log');
                const form = document.getElementById('chatForm');
                const input = document.getElementById('input');
                const statusEl = document.getElementById('status');
                const sendBtn = document.getElementById('sendBtn');

                const cfgBtn = document.getElementById('cfgBtn');
                const cfgDlg = document.getElementById('cfgDlg');
                const cfgForm = document.getElementById('cfgForm');
                const cfgUser = document.getElementById('cfgUser');
                const cfgPass = document.getElementById('cfgPass');
                const cfgBase = document.getElementById('cfgBase');

                // WebSocket connection
                let ws = null;
                let wsReconnectAttempts = 0;
                const maxReconnectAttempts = 5;

                function connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    ws = new WebSocket(wsUrl);
                    
                    ws.onopen = function() {
                        console.log('WebSocket connected');
                        wsReconnectAttempts = 0;
                        statusEl.textContent = 'Connected';
                    };
                    
                    ws.onclose = function() {
                        console.log('WebSocket disconnected');
                        statusEl.textContent = 'Disconnected';
                        
                        // Attempt to reconnect
                        if (wsReconnectAttempts < maxReconnectAttempts) {
                            wsReconnectAttempts++;
                            console.log(`Attempting to reconnect... (${wsReconnectAttempts}/${maxReconnectAttempts})`);
                            setTimeout(connectWebSocket, 2000 * wsReconnectAttempts);
                        } else {
                            add('system', 'WebSocket connection lost. Please refresh the page.');
                        }
                    };
                    
                    ws.onerror = function(error) {
                        console.error('WebSocket error:', error);
                        statusEl.textContent = 'Connection Error';
                    };
                }

                // Connect on page load
                connectWebSocket();

                
                // Surface JS errors in the UI so users see why nothing appears
                function logErrorToUI(text){
                    try{
                        const wrap = document.createElement('div');
                        wrap.className = 'msg system';
                        const bubble = document.createElement('div');
                        bubble.className = 'bubble';
                        bubble.textContent = String(text);
                        wrap.appendChild(bubble);
                        logEl.appendChild(wrap);
                        logEl.scrollTop = logEl.scrollHeight;
                    }catch(_e){ /* ignore */ }
                }
                window.addEventListener('error', (e)=>{
                    const msg = e && (e.message || (e.error && e.error.message)) || 'Unknown script error';
                    logErrorToUI('JS Error: ' + msg);
                });
                window.addEventListener('unhandledrejection', (e)=>{
                    const r = e && e.reason;
                    const msg = typeof r === 'string' ? r : (r && r.message) ? r.message : (r ? JSON.stringify(r) : 'Unknown promise rejection');
                    logErrorToUI('Unhandled rejection: ' + msg);
                });
                
                let currentPlan = null;
                function add(role, content){
                    const wrap = document.createElement('div');
                    wrap.className = 'msg ' + role;
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';

                    let displayText = content;
                    let plan = null;
                    let executions = null;

                    if(role === 'assistant' && content && typeof content === 'object'){
                        plan = (typeof content.plan !== 'undefined') ? content.plan : null;
                        executions = (typeof content.executions !== 'undefined') ? content.executions : null;
                        if(typeof content.answer === 'string'){
                            displayText = content.answer;
                        } else if(typeof content.response === 'string'){
                            displayText = content.response;
                        } else if(content.response && typeof content.response === 'object'){
                            displayText = JSON.stringify(content.response, null, 2);
                        } else if(content.plan){
                            displayText = 'Plan generated.';
                        } else {
                            displayText = JSON.stringify(content, null, 2);
                        }
                    } else if(typeof displayText === 'object'){
                        displayText = JSON.stringify(displayText, null, 2);
                    }

                    bubble.textContent = displayText;
                    wrap.appendChild(bubble);

                    if(role === 'assistant' && (plan || executions)){
                        const details = document.createElement('details');
                        details.style.marginTop = '0.25rem';
                        const summary = document.createElement('summary');
                        summary.textContent = 'Show reasoning / execution details';
                        details.appendChild(summary);

                        if(plan !== null){
                            const prePlan = document.createElement('pre');
                            prePlan.style.whiteSpace = 'pre-wrap';
                            prePlan.style.margin = '0.5rem 0';
                            prePlan.textContent = 'Plan:\n' + JSON.stringify(plan, null, 2);
                            details.appendChild(prePlan);
                        }
                        if(executions !== null){
                            const preExec = document.createElement('pre');
                            preExec.style.whiteSpace = 'pre-wrap';
                            preExec.style.margin = '0.5rem 0';
                            preExec.textContent = 'Executions:\n' + JSON.stringify(executions, null, 2);
                            details.appendChild(preExec);
                        }
                        wrap.appendChild(details);
                    }

                    logEl.appendChild(wrap);
                    logEl.scrollTop = logEl.scrollHeight;
                }

                add('system', 'Connecting to chat server... Please click "Login & Configure" to set up your credentials.');

                cfgBtn.addEventListener('click', ()=> cfgDlg.showModal());
                const loginStatusEl = document.getElementById('loginStatus');
                
                function updateLoginStatus(isConfigured, message = '') {
                    if (isConfigured) {
                        loginStatusEl.textContent = 'Authenticated ✓';
                        loginStatusEl.style.color = '#4ade80';
                        cfgBtn.textContent = 'Reconfigure';
                        cfgBtn.style.background = '#2d5fff';
                        cfgBtn.style.borderColor = '#2d5fff';
                        cfgBtn.style.marginLeft = '0.5rem';
                        
                        // Show success message if provided
                        if (message) {
                            showStatusMessage(message, 'success');
                        }
                    } else {
                        loginStatusEl.textContent = 'Not Authenticated ✗';
                        loginStatusEl.style.color = '#ff6b6b';
                        cfgBtn.textContent = 'Login & Configure';
                        cfgBtn.style.background = '#ff6b6b';
                        cfgBtn.style.borderColor = '#ff6b6b';
                        cfgBtn.style.marginLeft = 'auto';
                        
                        // Show error message if provided
                        if (message) {
                            showStatusMessage(message, 'error');
                        }
                    }
                }
                
                function showStatusMessage(message, type = 'info') {
                    // Remove existing status messages
                    const existingMessages = document.querySelectorAll('.status-message');
                    existingMessages.forEach(msg => msg.remove());
                    
                    // Create new status message
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `status-message ${type}`;
                    messageDiv.textContent = message;
                    
                    // Insert after login status
                    const statusElement = document.getElementById('loginStatus');
                    statusElement.parentNode.insertBefore(messageDiv, statusElement.nextSibling);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.remove();
                        }
                    }, 5000);
                }

                cfgForm.addEventListener('submit', async (e)=>{
                    e.preventDefault();
                    const body = {
                        username: cfgUser.value.trim(),
                        password: cfgPass.value
                    };
                    try{
                        // Set credentials
                        add('system', 'Setting credentials...');
                        const resp = await fetch('/credentials', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
                        if(!resp.ok) throw new Error('HTTP '+resp.status);
                        
                        const result = await resp.json();
                        if (result.status === 'success') {
                            add('system', '✅ Credentials set successfully! Now logging in...');
                            showStatusMessage('Credentials saved successfully. Attempting login...', 'info');
                            
                            // Login
                            const loginResp = await fetch('/login', {method:'POST', headers:{'Content-Type':'application/json'}});
                            if(!loginResp.ok) throw new Error('HTTP '+loginResp.status);
                            
                            const loginResult = await loginResp.json();
                            if (loginResult.status === 'success') {
                                add('system', '✅ Login successful! You can now use the assistant.');
                                updateLoginStatus(true, 'Successfully authenticated! You can now access your financial data.');
                                cfgDlg.close();
                            } else {
                                add('system', '⚠️ Login failed: ' + (loginResult.message || 'Unknown error'));
                            }
                        } else {
                            add('system', '⚠️ Failed to set credentials: ' + (result.message || 'Unknown error'));
                        }
                    }catch(err){
                        add('assistant', 'Config error: '+err.message);
                        updateLoginStatus(false, `Authentication failed: ${err.message}`);
                    }
                });

                async function callAssistant(message){
                    return new Promise((resolve, reject) => {
                        if (!ws || ws.readyState !== WebSocket.OPEN) {
                            reject(new Error('WebSocket not connected'));
                            return;
                        }
                        
                        // Set up response handler
                        const messageHandler = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                if (data.type === 'bot_response') {
                                    ws.removeEventListener('message', messageHandler);
                                    resolve(data.content);
                                } else if (data.type === 'mcp_response') {
                                    ws.removeEventListener('message', messageHandler);
                                    resolve(data.content);
                                } else if (data.type === 'fallback_response') {
                                    ws.removeEventListener('message', messageHandler);
                                    let response = data.content;
                                    if (data.details) {
                                        response += '\n\nTechnical details: ' + data.details;
                                    }
                                    resolve(response);
                                } else if (data.type === 'error') {
                                    ws.removeEventListener('message', messageHandler);
                                    reject(new Error(data.content));
                                }
                            } catch (err) {
                                ws.removeEventListener('message', messageHandler);
                                reject(err);
                            }
                        };
                        
                        ws.addEventListener('message', messageHandler);
                        
                        // Send message
                        ws.send(message);
                        
                        // Timeout after 30 seconds
                        setTimeout(() => {
                            ws.removeEventListener('message', messageHandler);
                            reject(new Error('Request timeout'));
                        }, 30000);
                    });
                }



                form.addEventListener('submit', async (e)=>{
                    e.preventDefault();
                    const text = input.value.trim();
                    if(!text) return;
                    
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        add('system', 'WebSocket not connected. Please wait for connection or refresh the page.');
                        return;
                    }
                    
                    input.value='';
                    add('user', text);
                    statusEl.textContent = 'Thinking…';
                    sendBtn.disabled = true;
                    try {
                        let result = await callAssistant(text);
                        add('assistant', result);
                    } catch(err){
                        add('assistant', 'Error: '+ err.message);
                    } finally {
                        sendBtn.disabled = false;
                        statusEl.textContent = ws && ws.readyState === WebSocket.OPEN ? 'Connected' : 'Disconnected';
                        input.focus();
                    }
                });
            </script>
        </body>
        </html>
        
